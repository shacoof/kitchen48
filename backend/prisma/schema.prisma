// Prisma Schema for Kitchen48
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL") // For DBaaS with connection pooling (e.g., Neon, Supabase)
}

// ============================================================================
// Enums
// ============================================================================

enum UserType {
  regular
  admin
}

enum DataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DATE
  COLOR
  ARRAY
}

enum OwnerType {
  SYSTEM
  ORGANIZATION
  USER
}

// ============================================================================
// Core Models
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Profile Information
  firstName      String?  @map("first_name")
  lastName       String?  @map("last_name")
  nickname       String?  @unique @map("nickname") // Unique URL-friendly identifier (e.g., jsmith)
  profilePicture String?  @map("profile_picture") // URL or path to profile image
  phone          String?
  phoneCountry   String?  @map("phone_country") // ISO country code (e.g., "US", "IL")
  description    String?

  // Authentication
  passwordHash             String?   @map("password_hash")
  emailVerified            Boolean   @default(false) @map("email_verified")
  emailVerificationToken   String?   @unique @map("email_verification_token")
  emailVerificationExpires DateTime? @map("email_verification_expires")

  // Authorization
  userType UserType @default(regular) @map("user_type")

  // Relations
  recipes       Recipe[]
  savedRecipes  SavedRecipe[]
  oauthAccounts OAuthAccount[]

  @@map("users")
}

model OAuthAccount {
  id                String    @id @default(cuid())
  provider          String    // "google", "facebook", "instagram"
  providerAccountId String    @map("provider_account_id") // ID from the OAuth provider
  accessToken       String?   @map("access_token")
  refreshToken      String?   @map("refresh_token")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

model Recipe {
  id          String   @id @default(cuid())
  title       String
  description String?
  prepTime    Int?     @map("prep_time") // in minutes
  cookTime    Int?     @map("cook_time") // in minutes
  servings    Int?
  imageUrl    String?  @map("image_url")
  videoUrl    String?  @map("video_url")
  isPublished Boolean  @default(false) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  authorId    String        @map("author_id")
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  ingredients Ingredient[]
  steps       Step[]
  savedBy     SavedRecipe[]

  @@map("recipes")
}

model Ingredient {
  id       String  @id @default(cuid())
  name     String
  amount   String? // e.g., "2 cups", "1 tbsp"
  order    Int     @default(0)

  // Relations
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("ingredients")
}

model Step {
  id          String  @id @default(cuid())
  instruction String
  order       Int
  duration    Int?    // in seconds (for voice playback timing)

  // Relations
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("steps")
}

model SavedRecipe {
  id      String   @id @default(cuid())
  savedAt DateTime @default(now()) @map("saved_at")

  // Relations
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("saved_recipes")
}

// ============================================================================
// System Configuration
// ============================================================================

model Parameter {
  id        String   @id @default(cuid())
  key       String
  value     String?
  dataType  DataType @default(STRING) @map("data_type")
  ownerType OwnerType @default(SYSTEM) @map("owner_type")
  ownerId   String?  @map("owner_id")
  category  String?
  description String?

  // Metadata
  isEncrypted     Boolean  @default(false) @map("is_encrypted")
  defaultValue    String?  @map("default_value")
  validationRules String?  @map("validation_rules") // JSON string

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  @@unique([key, ownerType, ownerId])
  @@map("parameters")
}
