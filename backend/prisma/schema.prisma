// Prisma Schema for Kitchen48
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL") // For DBaaS with connection pooling (e.g., Neon, Supabase)
}

// ============================================================================
// Enums
// ============================================================================

enum UserType {
  regular
  admin
}

enum DataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DATE
  COLOR
  ARRAY
}

enum OwnerType {
  SYSTEM
  ORGANIZATION
  USER
}

enum TimeUnit {
  SECONDS
  MINUTES
  HOURS
  DAYS
}

// ============================================================================
// Core Models
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Profile Information
  firstName      String?  @map("first_name")
  lastName       String?  @map("last_name")
  nickname       String?  @unique @map("nickname") // Unique URL-friendly identifier (e.g., jsmith)
  profilePicture String?  @map("profile_picture") // URL or path to profile image
  phone          String?
  phoneCountry   String?  @map("phone_country") // ISO country code (e.g., "US", "IL")
  description    String?

  // Language Preferences
  videoLanguage     String @default("en") @map("video_language")     // ISO 639-1 code for video/audio content
  interfaceLanguage String @default("en") @map("interface_language") // ISO 639-1 code for UI language

  // Authentication
  passwordHash             String?   @map("password_hash")
  emailVerified            Boolean   @default(false) @map("email_verified")
  emailVerificationToken   String?   @unique @map("email_verification_token")
  emailVerificationExpires DateTime? @map("email_verification_expires")

  // Authorization
  userType UserType @default(regular) @map("user_type")

  // Relations
  recipes       Recipe[]
  savedRecipes  SavedRecipe[]
  oauthAccounts OAuthAccount[]
  sessions      Session[]
  statEvents    StatEvent[]

  @@map("users")
}

model OAuthAccount {
  id                String    @id @default(cuid())
  provider          String    // "google", "facebook", "instagram"
  providerAccountId String    @map("provider_account_id") // ID from the OAuth provider
  accessToken       String?   @map("access_token")
  refreshToken      String?   @map("refresh_token")
  expiresAt         DateTime? @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

model Recipe {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(80) // Max 80 characters as per HLD
  slug        String   // URL-friendly name, unique per author
  description String?
  prepTime    Int?     @map("prep_time") // in minutes
  cookTime    Int?     @map("cook_time") // in minutes
  servings    Int?
  imageUrl    String?  @map("image_url")
  videoUrl    String?  @map("video_url") // Intro video for the recipe
  isPublished Boolean  @default(false) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  authorId    String             @map("author_id")
  author      User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
  steps       Step[]
  savedBy     SavedRecipe[]

  @@unique([authorId, slug]) // Combination of author + slug must be unique
  @@map("recipes")
}

model RecipeIngredient {
  id       String  @id @default(cuid())
  name     String
  amount   String? // e.g., "2 cups", "1 tbsp"
  order    Int     @default(0)

  // Relations
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_ingredients")
}

model StepIngredient {
  id     String  @id @default(cuid())
  name   String  // Custom name if not from master, or copied from master
  amount String? // e.g., "2 cups", "1 tbsp"
  order  Int     @default(0)

  // Relations
  stepId             String            @map("step_id")
  step               Step              @relation(fields: [stepId], references: [id], onDelete: Cascade)
  masterIngredientId String?           @map("master_ingredient_id") // If from master table
  masterIngredient   MasterIngredient? @relation(fields: [masterIngredientId], references: [id], onDelete: SetNull)

  @@map("step_ingredients")
}

model MasterIngredient {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String?
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  stepIngredients StepIngredient[]

  @@map("master_ingredients")
}

model Step {
  id          String    @id @default(cuid())
  slug        String?   // URL-friendly step name (step1, step2, or custom)
  instruction String    // Step description (mandatory)
  order       Int
  duration    Int?      // in seconds (for voice playback timing)
  videoUrl    String?   @map("video_url") // Short video (up to 1 min)
  workTime    Int?      @map("work_time") // How much work time this step takes
  workTimeUnit TimeUnit? @map("work_time_unit")
  waitTime    Int?      @map("wait_time") // Wait time (e.g., in oven, dough rising)
  waitTimeUnit TimeUnit? @map("wait_time_unit")

  // Relations
  recipeId    String           @map("recipe_id")
  recipe      Recipe           @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredients StepIngredient[]

  @@unique([recipeId, slug]) // Step slug unique within recipe
  @@map("steps")
}

model SavedRecipe {
  id      String   @id @default(cuid())
  savedAt DateTime @default(now()) @map("saved_at")

  // Relations
  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId String @map("recipe_id")
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("saved_recipes")
}

// ============================================================================
// System Configuration
// ============================================================================

model Parameter {
  id        String   @id @default(cuid())
  key       String
  value     String?
  dataType  DataType @default(STRING) @map("data_type")
  ownerType OwnerType @default(SYSTEM) @map("owner_type")
  ownerId   String?  @map("owner_id")
  category  String?
  description String?

  // Metadata
  isEncrypted     Boolean  @default(false) @map("is_encrypted")
  defaultValue    String?  @map("default_value")
  validationRules String?  @map("validation_rules") // JSON string

  // Audit fields
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  @@unique([key, ownerType, ownerId])
  @@map("parameters")
}

// ============================================================================
// List of Values (LOV) - Configurable Dropdowns
// ============================================================================

model ListType {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  values      ListValue[]

  @@map("list_types")
}

model ListValue {
  id          String   @id @default(cuid())
  listTypeId  String   @map("list_type_id")
  value       String   // Internal code/key (e.g., "VEGETABLES")
  label       String   // Display text (e.g., "Vegetables")
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  listType     ListType              @relation(fields: [listTypeId], references: [id], onDelete: Cascade)
  translations ListValueTranslation[]

  @@unique([listTypeId, value])
  @@map("list_values")
}

model ListValueTranslation {
  id          String   @id @default(cuid())
  listValueId String   @map("list_value_id")
  language    String   // ISO 639-1 code: 'en', 'he', 'es', etc.
  label       String   // Translated display text
  description String?  // Translated description (optional)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  listValue   ListValue @relation(fields: [listValueId], references: [id], onDelete: Cascade)

  @@unique([listValueId, language])
  @@map("list_value_translations")
}

// ============================================================================
// Deployment & Migration Tracking
// ============================================================================

model DataMigration {
  id          String   @id @default(cuid())
  scriptName  String   @unique @map("script_name")  // e.g., "1.1.0_add_user_nicknames.ts"
  version     String                                 // Database version this belongs to
  description String?
  executedAt  DateTime @default(now()) @map("executed_at")
  executedBy  String?  @map("executed_by")           // "deploy-script" or user email
  success     Boolean  @default(true)
  errorLog    String?  @map("error_log")

  @@map("data_migrations")
}

// ============================================================================
// Statistics & Analytics
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  deviceType   String   @map("device_type")  // 'browser', 'mobile_app', 'tablet'
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  startedAt    DateTime @default(now()) @map("started_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")

  // Relations
  user   User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  events StatEvent[]

  @@index([userId])
  @@index([startedAt])
  @@map("sessions")
}

model StatEvent {
  id         String   @id @default(cuid())
  eventType  String   @map("event_type")   // e.g., 'user.login', 'recipe.view'
  userId     String?  @map("user_id")
  sessionId  String?  @map("session_id")
  entityType String?  @map("entity_type")  // e.g., 'recipe', 'user'
  entityId   String?  @map("entity_id")
  metadata   Json?                         // Flexible additional data
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([eventType])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("stat_events")
}
